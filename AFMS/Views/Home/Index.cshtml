@model List<AFMS.Models.AeroDataBoxFlight>

@{
    ViewData["Title"] = "Dashboard";

    var totalDepartures = Model.Count(f => f.Direction == "Departure");
    var totalArrivals = Model.Count(f => f.Direction == "Arrival");
}

<!-- Page Header -->
<div class="page-header">
    <h1 class="page-title">Dashboard</h1>
    <p class="page-subtitle">London Heathrow Airport (LHR/EGLL) - Live Flight Data</p>
</div>

<!-- Stats Grid - Main -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-content">
            <div class="stat-label">Total Flights</div>
            <div class="stat-value">@Model.Count</div>
        </div>
        <div class="stat-badge positive">Live Data</div>
    </div>

    <div class="stat-card">
        <div class="stat-content">
            <div class="stat-label">Departures</div>
            <div class="stat-value">@totalDepartures</div>
        </div>
        <div class="stat-badge positive">Live Data</div>
    </div>

    <div class="stat-card">
        <div class="stat-content">
            <div class="stat-label">Arrivals</div>
            <div class="stat-value">@totalArrivals</div>
        </div>
        <div class="stat-badge positive">Live Data</div>
    </div>

    <div class="stat-card">
        <div class="stat-content">
            <div class="stat-label">Airlines</div>
            <div class="stat-value">@Model.Select(f => f.Airline?.Name).Where(n => n != null).Distinct().Count()</div>
        </div>
        <div class="stat-badge positive">Live Data</div>
    </div>
</div>

<!-- Flights Section -->
<div class="flights-section">
    <div class="flights-header">
        <h2 class="section-title">Live Flights - London Heathrow (LHR)</h2>
        <div class="direction-filters">
            <button class="filter-btn active" data-direction="all">All</button>
            <button class="filter-btn" data-direction="Departure">Departures</button>
            <button class="filter-btn" data-direction="Arrival">Arrivals</button>
        </div>
    </div>
    <div class="table-wrapper">
        <table class="flights-table" id="flightsTable">
            <thead>
                <tr>
                    <th>TIME</th>
                    <th>FLIGHT</th>
                    <th class="from-col">FROM</th>
                    <th class="to-col">TO</th>
                    <th>AIRLINE</th>
                    <th>AIRCRAFT</th>
                    <th>STATUS</th>
                </tr>
            </thead>
            <tbody>
                @{
                    string lastDate = "";
                    var seenFlights = new HashSet<string>();
                }
                @foreach (var flight in Model)
                {
                    // Remove duplicates by flight number
                    var flightKey = $"{flight.Number}_{flight.Direction}";
                    if (seenFlights.Contains(flightKey))
                    {
                        continue;
                    }
                    seenFlights.Add(flightKey);
                    
                    var isDep = flight.Direction == "Departure";
                    // Use movement-level status: departure.status for departures, arrival.status for arrivals
                    var movementStatus = isDep ? flight.Departure?.Status : flight.Arrival?.Status;
                    var rawStatus = (movementStatus ?? flight.Status ?? "Unknown").ToLower();

                    // Simplified status mapping for user-friendly display
                    var statusClass = rawStatus switch
                    {
                        "expected"          => "status-ontime",
                        "enroute"           => "status-departed",
                        "checkin"           => "status-ontime",
                        "boarding"          => "status-boarding",
                        "gateclosed"        => "status-departed",
                        "departed"          => "status-departed",
                        "delayed"           => "status-delayed",
                        "approaching"       => "status-departed",
                        "arrived"           => "status-landed",
                        "canceled"          => "status-cancelled",
                        "canceleduncertain" => "status-cancelled",
                        "diverted"          => "status-cancelled",
                        "unknown"           => "status-ontime",
                        _                   => "status-ontime"
                    };

                    // Simplified status labels
                    var statusLabel = rawStatus switch
                    {
                        "expected"          => "On Time",
                        "enroute"           => "Departed",
                        "checkin"           => "On Time",
                        "boarding"          => "Boarding",
                        "gateclosed"        => "Departed",
                        "departed"          => "Departed",
                        "delayed"           => "Delayed",
                        "approaching"       => "Departed",
                        "arrived"           => "Landed",
                        "canceled"          => "Cancelled",
                        "canceleduncertain" => "Cancelled",
                        "diverted"          => "Cancelled",
                        "unknown"           => "On Time",
                        _                   => "On Time"
                    };

                    // Airport codes — fill in LHR for the home leg
                    var depIata = flight.Departure?.Airport?.Iata
                        ?? (isDep ? "LHR" : (flight.Departure?.Airport?.Name ?? "-"));
                    var arrIata = flight.Arrival?.Airport?.Iata
                        ?? (!isDep ? "LHR" : (flight.Arrival?.Airport?.Name ?? "-"));

                    // Departure date/time with day name
                    var departureTime = "-";
                    if (DateTime.TryParse(flight.Departure?.ScheduledTime?.Local, out var depParsed))
                        departureTime = depParsed.ToString("ddd dd MMM HH:mm");

                    // Arrival date/time with day name
                    var arrivalTime = "-";
                    if (DateTime.TryParse(flight.Arrival?.ScheduledTime?.Local, out var arrParsed))
                        arrivalTime = arrParsed.ToString("ddd dd MMM HH:mm");

                    // Gate / Terminal from the LHR leg
                    var gate = "-";
                    var terminal = "-";
                    var lhrLeg = isDep ? flight.Departure : flight.Arrival;
                    if (lhrLeg != null)
                    {
                        gate = !string.IsNullOrEmpty(lhrLeg.Gate) ? lhrLeg.Gate : "-";
                        terminal = !string.IsNullOrEmpty(lhrLeg.Terminal) ? lhrLeg.Terminal : "-";
                    }

                    // Get city names and format location string
                    var depCity = flight.Departure?.Airport?.MunicipalityName ?? flight.Departure?.Airport?.ShortName ?? depIata;
                    var arrCity = flight.Arrival?.Airport?.MunicipalityName ?? flight.Arrival?.Airport?.ShortName ?? arrIata;
                    var fromLocation = $"{depCity} ({depIata})";
                    var toLocation = $"{arrCity} ({arrIata})";
                    
                    // Get aircraft info
                    var aircraftModel = flight.Aircraft?.Model ?? "";
                    var aircraftReg = flight.Aircraft?.Reg ?? "";
                    var aircraftInfo = !string.IsNullOrEmpty(aircraftModel) 
                        ? (!string.IsNullOrEmpty(aircraftReg) ? $"{aircraftModel} ({aircraftReg})" : aircraftModel)
                        : "-";
                    
                    // Get UTC times for progress calculation
                    var depUtc = flight.Departure?.ScheduledTime?.Utc ?? "";
                    var arrUtc = flight.Arrival?.ScheduledTime?.Utc ?? "";
                    var runwayDepUtc = flight.Departure?.RunwayTime?.Utc ?? "";
                    var runwayArrUtc = flight.Arrival?.RunwayTime?.Utc ?? "";
                    
                    // Get revised/predicted times if available (for better progress tracking)
                    var revisedDepUtc = flight.Departure?.RevisedTime?.Utc ?? "";
                    var revisedArrUtc = flight.Arrival?.RevisedTime?.Utc ?? "";
                    var predictedDepUtc = flight.Departure?.PredictedTime?.Utc ?? "";
                    var predictedArrUtc = flight.Arrival?.PredictedTime?.Utc ?? "";

                    // Build detailed status with time information - use raw status to determine state
                    var detailedStatus = statusLabel;
                    var hasActuallyDeparted = !string.IsNullOrEmpty(runwayDepUtc) || rawStatus == "enroute" || rawStatus == "approaching" || rawStatus == "departed" || rawStatus == "gateclosed";
                    var hasActuallyArrived = !string.IsNullOrEmpty(runwayArrUtc) || rawStatus == "arrived";
                    
                    if (hasActuallyArrived)
                    {
                        if (DateTime.TryParse(runwayArrUtc, out var actArrTime))
                        {
                            detailedStatus = $"Landed {actArrTime.ToLocalTime().ToString("HH:mm")}";
                        }
                        else
                        {
                            detailedStatus = "Landed";
                        }
                        statusLabel = "Landed";
                        statusClass = "status-landed";
                    }
                    else if (hasActuallyDeparted && isDep)
                    {
                        if (DateTime.TryParse(runwayDepUtc, out var actDepTime))
                        {
                            detailedStatus = $"Departed {actDepTime.ToLocalTime().ToString("HH:mm")}";
                        }
                        else
                        {
                            detailedStatus = "Departed";
                        }
                        statusLabel = "Departed";
                        statusClass = "status-departed";
                    }
                    else if (hasActuallyDeparted && !isDep)
                    {
                        // Arrival that's in flight
                        detailedStatus = rawStatus == "approaching" ? "Approaching" : "In Flight";
                        statusLabel = detailedStatus;
                        statusClass = "status-departed";
                    }
                    else if (rawStatus == "delayed")
                    {
                        detailedStatus = "Delayed";
                    }
                    else if (rawStatus == "boarding")
                    {
                        detailedStatus = "Boarding";
                    }
                    else if (rawStatus == "canceled")
                    {
                        detailedStatus = "Canceled";
                    }
                    
                    // Use consistent time for display and sorting (the LHR leg time)
                    var displayTime = isDep ? depParsed.ToString("HH:mm") : arrParsed.ToString("HH:mm");
                    var sortTime = isDep ? depParsed : arrParsed;
                    var dateHeader = sortTime.ToString("dddd, MMM dd");
                    
                    // Show date header if date changed
                    if (dateHeader != lastDate)
                    {
                        lastDate = dateHeader;
                        <tr class="date-header-row">
                            <td colspan="7" class="date-header">@dateHeader</td>
                        </tr>
                    }

                    <tr data-direction="@flight.Direction" 
                        class="flight-row" 
                        data-flight-number="@flight.Number"
                        data-airline="@(flight.Airline?.Name ?? "-")"
                        data-dep-iata="@depIata"
                        data-arr-iata="@arrIata"
                        data-dep-city="@depCity"
                        data-arr-city="@arrCity"
                        data-dep-time="@departureTime"
                        data-arr-time="@arrivalTime"
                        data-dep-utc="@depUtc"
                        data-arr-utc="@arrUtc"
                        data-runway-dep-utc="@runwayDepUtc"
                        data-runway-arr-utc="@runwayArrUtc"
                        data-revised-dep-utc="@revisedDepUtc"
                        data-revised-arr-utc="@revisedArrUtc"
                        data-predicted-dep-utc="@predictedDepUtc"
                        data-predicted-arr-utc="@predictedArrUtc"
                        data-raw-status="@rawStatus"
                        data-gate="@gate"
                        data-terminal="@terminal"
                        data-status-class="@statusClass"
                        data-status-label="@detailedStatus">
                        <td class="time-col">@displayTime</td>
                        <td class="flight-number">@flight.Number</td>
                        <td class="from-col">@fromLocation</td>
                        <td class="to-col">@toLocation</td>
                        <td>@(flight.Airline?.Name ?? "-")</td>
                        <td class="aircraft-col">@aircraftInfo</td>
                        <td class="status-col"><span class="status-badge @statusClass">@detailedStatus</span></td>
                    </tr>
                }
            </tbody>
        </table>

        @if (!Model.Any())
        {
            <div class="empty-state">
                <p style="font-size: 18px; margin-bottom: 8px;">No live flight data available</p>
                <p>The API may not have returned data for the current time window.</p>
            </div>
        }
    </div>

    <!-- Pagination -->
    <div class="pagination" id="pagination"></div>
</div>

<!-- Flight Details Modal -->
<div class="modal-overlay" id="flightModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeFlightModal()">&times;</button>
        <div class="modal-header">
            <div class="modal-airline" id="modalAirline"></div>
            <div class="modal-flight-number" id="modalFlightNumber"></div>
            <div class="modal-route" id="modalRoute"></div>
        </div>
        <div class="modal-status-banner" id="modalStatusBanner">
            <span id="modalStatus"></span>
        </div>
        <div class="modal-body">
            <!-- Flight Progress Tracker -->
            <div class="flight-progress-section">
                <div class="progress-header">
                    <span class="progress-label" id="progressLabel">Flight Progress</span>
                </div>
                <div class="progress-route">
                    <div class="progress-airport-info" id="progressDepCode"></div>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar">
                            <div class="progress-bar-fill" id="progressBarFill"></div>
                            <div class="progress-indicator" id="progressPlane"></div>
                        </div>
                    </div>
                    <div class="progress-airport-info" id="progressArrCode"></div>
                </div>
                <div class="progress-time-info" id="progressTimeInfo"></div>
            </div>
            
            <div class="modal-section">
                <div class="modal-airport-block">
                    <div class="airport-code" id="modalDepCode"></div>
                    <div class="airport-info">
                        <div class="airport-label" id="modalDepCity"></div>
                        <div class="flight-time-group">
                            <div class="time-label" id="depTimeLabel">Scheduled departure</div>
                            <div class="time-display">
                                <span class="time-main" id="modalDepTime"></span>
                                <span class="time-secondary" id="modalDepTimeOriginal"></span>
                            </div>
                        </div>
                        <div class="airport-details">
                            <span class="detail-label">Terminal</span>
                            <span class="detail-value" id="modalDepTerminal"></span>
                            <span class="detail-label">Gate</span>
                            <span class="detail-value" id="modalDepGate"></span>
                        </div>
                    </div>
                </div>
                
                <div class="flight-duration">
                    <div class="duration-text" id="flightDuration"></div>
                </div>
                
                <div class="modal-airport-block">
                    <div class="airport-code" id="modalArrCode"></div>
                    <div class="airport-info">
                        <div class="airport-label" id="modalArrCity"></div>
                        <div class="flight-time-group">
                            <div class="time-label" id="arrTimeLabel">Scheduled arrival</div>
                            <div class="time-display">
                                <span class="time-main" id="modalArrTime"></span>
                                <span class="time-secondary" id="modalArrTimeOriginal"></span>
                            </div>
                        </div>
                        <div class="airport-details">
                            <span class="detail-label">Terminal</span>
                            <span class="detail-value" id="modalArrTerminal"></span>
                            <span class="detail-label">Gate</span>
                            <span class="detail-value" id="modalArrGate"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
(function () {
    const PAGE_SIZE = 25;
    let currentPage = 1;
    let currentDir = 'all';

    const allRows = Array.from(document.querySelectorAll('#flightsTable tbody tr'));
    const flightRows = allRows.filter(r => r.classList.contains('flight-row'));
    const dateHeaderRows = allRows.filter(r => r.classList.contains('date-header-row'));
    const buttons = document.querySelectorAll('.filter-btn');
    const pagination = document.getElementById('pagination');

    function getFilteredRows() {
        if (currentDir === 'all') {
            return flightRows;
        }
        return flightRows.filter(r => r.getAttribute('data-direction') === currentDir);
    }

    function render() {
        const filtered = getFilteredRows();
        const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
        if (currentPage > totalPages) currentPage = totalPages;

        // Hide all rows first
        flightRows.forEach(r => r.style.display = 'none');
        dateHeaderRows.forEach(r => r.style.display = 'none');

        // Show only current page flight rows
        const start = (currentPage - 1) * PAGE_SIZE;
        const end = start + PAGE_SIZE;
        const visibleFlights = filtered.slice(start, end);
        visibleFlights.forEach(r => r.style.display = '');
        
        // Re-attach click handlers after changing display
        attachFlightRowHandlers();
        
        // Show date headers if there are visible flights after them
        dateHeaderRows.forEach(header => {
            let hasVisibleFlight = false;
            let nextRow = header.nextElementSibling;
            
            while (nextRow) {
                if (nextRow.classList.contains('date-header-row')) {
                    break; // Stop at next date header
                }
                if (nextRow.classList.contains('flight-row') && nextRow.style.display !== 'none') {
                    hasVisibleFlight = true;
                    break;
                }
                nextRow = nextRow.nextElementSibling;
            }
            
            if (hasVisibleFlight) {
                header.style.display = '';
            }
        });

        // Build pagination
        let html = '';
        html += '<button class="page-btn" data-page="prev" ' + (currentPage === 1 ? 'disabled' : '') + '>‹ Prev</button>';

        const maxButtons = 7;
        let startPage = Math.max(1, currentPage - 3);
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);
        if (endPage - startPage < maxButtons - 1) startPage = Math.max(1, endPage - maxButtons + 1);

        if (startPage > 1) {
            html += '<button class="page-btn" data-page="1">1</button>';
            if (startPage > 2) html += '<span class="page-ellipsis">…</span>';
        }
        for (let i = startPage; i <= endPage; i++) {
            html += '<button class="page-btn' + (i === currentPage ? ' active' : '') + '" data-page="' + i + '">' + i + '</button>';
        }
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) html += '<span class="page-ellipsis">…</span>';
            html += '<button class="page-btn" data-page="' + totalPages + '">' + totalPages + '</button>';
        }

        html += '<button class="page-btn" data-page="next" ' + (currentPage === totalPages ? 'disabled' : '') + '>Next ›</button>';
        html += '<span class="page-info">Showing ' + (filtered.length ? start + 1 : 0) + '–' + Math.min(end, filtered.length) + ' of ' + filtered.length + '</span>';

        pagination.innerHTML = html;
    }

    // Direction filter
    buttons.forEach(btn => {
        btn.addEventListener('click', function () {
            buttons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentDir = this.getAttribute('data-direction');
            currentPage = 1;
            render();
        });
    });

    // Pagination clicks
    pagination.addEventListener('click', function (e) {
        const btn = e.target.closest('.page-btn');
        if (!btn || btn.disabled) return;
        const val = btn.getAttribute('data-page');
        if (val === 'prev') currentPage--;
        else if (val === 'next') currentPage++;
        else currentPage = parseInt(val);
        render();
        document.querySelector('.flights-section').scrollIntoView({ behavior: 'smooth' });
    });

    render();
    
    // Attach click handlers after initial render
    attachFlightRowHandlers();
})();

// Flight Details Modal Functions
function closeFlightModal() {
    document.getElementById('flightModal').classList.remove('active');
}

function attachFlightRowHandlers() {
    document.querySelectorAll('.flight-row').forEach(row => {
        row.onclick = function() {
            openFlightModal(this);
        };
        row.style.cursor = 'pointer';
    });
}

function openFlightModal(row) {
    const modal = document.getElementById('flightModal');
    
    const flightNumber = row.getAttribute('data-flight-number');
    const airline = row.getAttribute('data-airline');
    const direction = row.getAttribute('data-direction');
    const depIata = row.getAttribute('data-dep-iata');
    const arrIata = row.getAttribute('data-arr-iata');
    const depCity = row.getAttribute('data-dep-city');
    const arrCity = row.getAttribute('data-arr-city');
    const depTime = row.getAttribute('data-dep-time');
    const arrTime = row.getAttribute('data-arr-time');
    const depUtc = row.getAttribute('data-dep-utc');
    const arrUtc = row.getAttribute('data-arr-utc');
    const runwayDepUtc = row.getAttribute('data-runway-dep-utc');
    const runwayArrUtc = row.getAttribute('data-runway-arr-utc');
    const revisedDepUtc = row.getAttribute('data-revised-dep-utc');
    const revisedArrUtc = row.getAttribute('data-revised-arr-utc');
    const predictedDepUtc = row.getAttribute('data-predicted-dep-utc');
    const predictedArrUtc = row.getAttribute('data-predicted-arr-utc');
    const rawStatus = row.getAttribute('data-raw-status');
    const gate = row.getAttribute('data-gate');
    const terminal = row.getAttribute('data-terminal');
    const statusClass = row.getAttribute('data-status-class');
    const statusLabel = row.getAttribute('data-status-label');
    
    const isDep = direction === 'Departure';
    
    document.getElementById('modalAirline').textContent = airline;
    document.getElementById('modalFlightNumber').textContent = flightNumber;
    document.getElementById('modalRoute').textContent = `${depIata} to ${arrIata}`;
    
    const statusBanner = document.getElementById('modalStatusBanner');
    statusBanner.className = 'modal-status-banner ' + statusClass;
    document.getElementById('modalStatus').textContent = statusLabel;
    
    document.getElementById('modalDepCode').textContent = depIata;
    document.getElementById('modalArrCode').textContent = arrIata;
    document.getElementById('modalDepCity').textContent = depCity;
    document.getElementById('modalArrCity').textContent = arrCity;
    
    const depLabel = depCity && depCity !== depIata ? `${depIata} ${depCity}` : depIata;
    const arrLabel = arrCity && arrCity !== arrIata ? `${arrIata} ${arrCity}` : arrIata;
    document.getElementById('progressDepCode').textContent = depLabel;
    document.getElementById('progressArrCode').textContent = arrLabel;
    
    document.getElementById('modalDepTerminal').textContent = isDep ? terminal : '-';
    document.getElementById('modalDepGate').textContent = isDep ? gate : '-';
    document.getElementById('modalArrTerminal').textContent = !isDep ? terminal : '-';
    document.getElementById('modalArrGate').textContent = !isDep ? gate : '-';
    
    document.getElementById('modalDepTime').textContent = depTime.split(' ').pop();
    document.getElementById('modalArrTime').textContent = arrTime.split(' ').pop();
    
    const depTimeOriginal = document.getElementById('modalDepTimeOriginal');
    const arrTimeOriginal = document.getElementById('modalArrTimeOriginal');
    
    if (runwayDepUtc) {
        depTimeOriginal.textContent = new Date(runwayDepUtc).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        depTimeOriginal.style.display = 'inline';
        document.getElementById('depTimeLabel').textContent = 'Actual departure';
    } else {
        depTimeOriginal.style.display = 'none';
        document.getElementById('depTimeLabel').textContent = 'Scheduled departure';
    }
    
    if (runwayArrUtc) {
        arrTimeOriginal.textContent = new Date(runwayArrUtc).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        arrTimeOriginal.style.display = 'inline';
        document.getElementById('arrTimeLabel').textContent = 'Actual arrival';
    } else {
        arrTimeOriginal.style.display = 'none';
        document.getElementById('arrTimeLabel').textContent = 'Scheduled arrival';
    }
    
    calculateFlightProgress(depUtc, arrUtc, runwayDepUtc, runwayArrUtc, revisedDepUtc, revisedArrUtc, predictedDepUtc, predictedArrUtc, rawStatus);
    
    modal.classList.add('active');
}

function calculateFlightProgress(depUtc, arrUtc, runwayDepUtc, runwayArrUtc, revisedDepUtc, revisedArrUtc, predictedDepUtc, predictedArrUtc, rawStatus) {
    if (!depUtc || !arrUtc) {
        document.getElementById('progressLabel').textContent = 'No data';
        document.getElementById('progressBarFill').style.width = '0%';
        document.getElementById('progressPlane').style.left = '0';
        document.getElementById('progressTimeInfo').textContent = '';
        return;
    }
    
    const depTime = new Date(depUtc);
    const arrTime = new Date(arrUtc);
    const now = new Date();
    
    // Flight duration
    const totalMins = (arrTime - depTime) / 60000;
    const hrs = Math.floor(totalMins / 60);
    const mins = Math.round(totalMins % 60);
    document.getElementById('flightDuration').textContent = `${hrs}h ${mins}m`;
    
    let progress = 0;
    let label = 'Scheduled';
    let info = '';
    
    // Check actual flight state from API data - use runway times (actual) and raw status
    const hasActuallyArrived = (runwayArrUtc && runwayArrUtc !== '') || rawStatus === 'arrived';
    const hasActuallyDeparted = (runwayDepUtc && runwayDepUtc !== '') || 
                                rawStatus === 'enroute' || 
                                rawStatus === 'approaching' || 
                                rawStatus === 'departed' || 
                                rawStatus === 'gateclosed';
    
    if (hasActuallyArrived) {
        progress = 100;
        label = 'Arrived';
        info = 'Flight completed';
    } else if (hasActuallyDeparted) {
        // Flight has departed - use best available departure time
        let actualDep;
        if (runwayDepUtc && runwayDepUtc !== '') {
            // Use actual runway time if available (most accurate)
            actualDep = new Date(runwayDepUtc);
        } else if (revisedDepUtc && revisedDepUtc !== '') {
            // Use revised time if no runway time
            actualDep = new Date(revisedDepUtc);
        } else if (predictedDepUtc && predictedDepUtc !== '') {
            // Use predicted time if no runway or revised
            actualDep = new Date(predictedDepUtc);
        } else {
            // Fallback to scheduled time
            actualDep = depTime;
        }
        
        // Use best available arrival time for progress calculation
        let estimatedArr;
        if (revisedArrUtc && revisedArrUtc !== '') {
            estimatedArr = new Date(revisedArrUtc);
        } else if (predictedArrUtc && predictedArrUtc !== '') {
            estimatedArr = new Date(predictedArrUtc);
        } else {
            estimatedArr = arrTime;
        }
        
        const elapsed = (now - actualDep) / 60000;
        const flightDuration = (estimatedArr - actualDep) / 60000;
        
        if (elapsed > 0 && flightDuration > 0) {
            progress = Math.min(95, Math.max(5, (elapsed / flightDuration) * 100));
            label = rawStatus === 'approaching' ? 'Approaching' : 'In Flight';
            const remaining = Math.max(0, flightDuration - elapsed);
            const remHrs = Math.floor(remaining / 60);
            const remMins = Math.round(remaining % 60);
            info = remHrs > 0 ? `${remHrs}h ${remMins}m remaining` : `${remMins} min remaining`;
        } else {
            // Just departed or bad data
            progress = 5;
            label = 'Departed';
            info = 'Flight in progress';
        }
    } else {
        // Not departed yet
        progress = 0;
        label = rawStatus === 'boarding' ? 'Boarding' : rawStatus === 'delayed' ? 'Delayed' : 'Scheduled';
        
        // Use best available departure time for countdown
        let effectiveDep = depTime;
        if (revisedDepUtc && revisedDepUtc !== '') {
            effectiveDep = new Date(revisedDepUtc);
        } else if (predictedDepUtc && predictedDepUtc !== '') {
            effectiveDep = new Date(predictedDepUtc);
        }
        
        const timeUntil = (effectiveDep - now) / 60000;
        if (timeUntil > 0 && timeUntil < 120) {
            info = timeUntil < 60 ? `Departs in ${Math.round(timeUntil)} min` : `Departs in ${Math.floor(timeUntil / 60)}h ${Math.round(timeUntil % 60)}m`;
        } else if (timeUntil < 0) {
            info = 'Flight delayed or status unknown';
        } else {
            info = `Departs ${effectiveDep.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}`;
        }
    }
    
    document.getElementById('progressLabel').textContent = label;
    document.getElementById('progressBarFill').style.width = progress + '%';
    document.getElementById('progressPlane').style.left = progress + '%';
    document.getElementById('progressTimeInfo').textContent = info;
}

// Close modal on overlay click
document.getElementById('flightModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeFlightModal();
    }
});
</script>
}
