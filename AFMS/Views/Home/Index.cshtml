@model List<AFMS.Models.AeroDataBoxFlight>

@{
    ViewData["Title"] = "Dashboard";

    var totalDepartures = Model.Count(f => f.Direction == "Departure");
    var totalArrivals = Model.Count(f => f.Direction == "Arrival");
}

<!-- Page Header -->
<div class="page-header">
    <h1 class="page-title">Dashboard</h1>
    <p class="page-subtitle">London Heathrow Airport (LHR/EGLL) - Live Flight Data</p>
</div>

<!-- Stats Grid - Main -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-content">
            <div class="stat-label">Total Flights</div>
            <div class="stat-value">@Model.Count</div>
        </div>
        <div class="stat-badge positive">Live Data</div>
    </div>

    <div class="stat-card">
        <div class="stat-content">
            <div class="stat-label">Departures</div>
            <div class="stat-value">@totalDepartures</div>
        </div>
        <div class="stat-badge positive">Live Data</div>
    </div>

    <div class="stat-card">
        <div class="stat-content">
            <div class="stat-label">Arrivals</div>
            <div class="stat-value">@totalArrivals</div>
        </div>
        <div class="stat-badge positive">Live Data</div>
    </div>

    <div class="stat-card">
        <div class="stat-content">
            <div class="stat-label">Airlines</div>
            <div class="stat-value">@Model.Select(f => f.Airline?.Name).Where(n => n != null).Distinct().Count()</div>
        </div>
        <div class="stat-badge positive">Live Data</div>
    </div>
</div>

<!-- Flights Section -->
<div class="flights-section">
    <div class="flights-header">
        <h2 class="section-title">Live Flights - London Heathrow (LHR)</h2>
        <div class="direction-filters">
            <button class="filter-btn active" data-direction="all">All</button>
            <button class="filter-btn" data-direction="Departure">Departures</button>
            <button class="filter-btn" data-direction="Arrival">Arrivals</button>
        </div>
    </div>
    <div class="table-wrapper">
        <table class="flights-table" id="flightsTable">
            <thead>
                <tr>
                    <th>Flight</th>
                    <th>Airline</th>
                    <th>Type</th>
                    <th>Route</th>
                    <th>Departure</th>
                    <th>Arrival</th>
                    <th>Gate</th>
                    <th>Terminal</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var flight in Model)
                {
                    var isDep = flight.Direction == "Departure";
                    // Use movement-level status: departure.status for departures, arrival.status for arrivals
                    var movementStatus = isDep ? flight.Departure?.Status : flight.Arrival?.Status;
                    var rawStatus = (movementStatus ?? flight.Status ?? "Unknown").ToLower();

                    // Simplified status mapping for user-friendly display
                    var statusClass = rawStatus switch
                    {
                        "expected"          => "status-ontime",
                        "enroute"           => "status-departed",
                        "checkin"           => "status-ontime",
                        "boarding"          => "status-boarding",
                        "gateclosed"        => "status-departed",
                        "departed"          => "status-departed",
                        "delayed"           => "status-delayed",
                        "approaching"       => "status-departed",
                        "arrived"           => "status-landed",
                        "canceled"          => "status-cancelled",
                        "canceleduncertain" => "status-cancelled",
                        "diverted"          => "status-cancelled",
                        "unknown"           => "status-ontime",
                        _                   => "status-ontime"
                    };

                    // Simplified status labels
                    var statusLabel = rawStatus switch
                    {
                        "expected"          => "On Time",
                        "enroute"           => "Departed",
                        "checkin"           => "On Time",
                        "boarding"          => "Boarding",
                        "gateclosed"        => "Departed",
                        "departed"          => "Departed",
                        "delayed"           => "Delayed",
                        "approaching"       => "Departed",
                        "arrived"           => "Landed",
                        "canceled"          => "Cancelled",
                        "canceleduncertain" => "Cancelled",
                        "diverted"          => "Cancelled",
                        "unknown"           => "On Time",
                        _                   => "On Time"
                    };

                    // Airport codes — fill in LHR for the home leg
                    var depIata = flight.Departure?.Airport?.Iata
                        ?? (isDep ? "LHR" : (flight.Departure?.Airport?.Name ?? "-"));
                    var arrIata = flight.Arrival?.Airport?.Iata
                        ?? (!isDep ? "LHR" : (flight.Arrival?.Airport?.Name ?? "-"));

                    // Departure date/time with day name
                    var departureTime = "-";
                    if (DateTime.TryParse(flight.Departure?.ScheduledTime?.Local, out var depParsed))
                        departureTime = depParsed.ToString("ddd dd MMM HH:mm");

                    // Arrival date/time with day name
                    var arrivalTime = "-";
                    if (DateTime.TryParse(flight.Arrival?.ScheduledTime?.Local, out var arrParsed))
                        arrivalTime = arrParsed.ToString("ddd dd MMM HH:mm");

                    // Gate / Terminal from the LHR leg
                    var gate = "-";
                    var terminal = "-";
                    var lhrLeg = isDep ? flight.Departure : flight.Arrival;
                    if (lhrLeg != null)
                    {
                        gate = !string.IsNullOrEmpty(lhrLeg.Gate) ? lhrLeg.Gate : "-";
                        terminal = !string.IsNullOrEmpty(lhrLeg.Terminal) ? lhrLeg.Terminal : "-";
                    }

                    var typeLabel = isDep ? "DEP" : "ARR";
                    
                    // Get other airport gate/terminal
                    var otherLeg = isDep ? flight.Arrival : flight.Departure;
                    var otherGate = !string.IsNullOrEmpty(otherLeg?.Gate) ? otherLeg.Gate : "-";
                    var otherTerminal = !string.IsNullOrEmpty(otherLeg?.Terminal) ? otherLeg.Terminal : "-";

                    // Get city names
                    var depCity = flight.Departure?.Airport?.MunicipalityName ?? flight.Departure?.Airport?.ShortName ?? "";
                    var arrCity = flight.Arrival?.Airport?.MunicipalityName ?? flight.Arrival?.Airport?.ShortName ?? "";
                    
                    // Get UTC times for progress calculation
                    var depUtc = flight.Departure?.ScheduledTime?.Utc ?? "";
                    var arrUtc = flight.Arrival?.ScheduledTime?.Utc ?? "";
                    var actualDepUtc = flight.Departure?.RunwayTime?.Utc ?? flight.Departure?.RevisedTime?.Utc ?? "";
                    var actualArrUtc = flight.Arrival?.RunwayTime?.Utc ?? flight.Arrival?.RevisedTime?.Utc ?? "";

                    <tr data-direction="@flight.Direction" 
                        class="flight-row" 
                        data-flight-number="@flight.Number"
                        data-airline="@(flight.Airline?.Name ?? "-")"
                        data-type="@typeLabel"
                        data-dep-iata="@depIata"
                        data-arr-iata="@arrIata"
                        data-dep-city="@depCity"
                        data-arr-city="@arrCity"
                        data-dep-time="@departureTime"
                        data-arr-time="@arrivalTime"
                        data-dep-utc="@depUtc"
                        data-arr-utc="@arrUtc"
                        data-actual-dep-utc="@actualDepUtc"
                        data-actual-arr-utc="@actualArrUtc"
                        data-lhr-gate="@gate"
                        data-lhr-terminal="@terminal"
                        data-other-gate="@otherGate"
                        data-other-terminal="@otherTerminal"
                        data-status="@statusLabel"
                        data-status-class="@statusClass"
                        data-raw-status="@rawStatus">
                        <td class="flight-number">@flight.Number</td>
                        <td>@(flight.Airline?.Name ?? "-")</td>
                        <td>@typeLabel</td>
                        <td>@depIata → @arrIata</td>
                        <td>@departureTime</td>
                        <td>@arrivalTime</td>
                        <td>@gate</td>
                        <td>@terminal</td>
                        <td><span class="status-badge @statusClass">@statusLabel</span></td>
                    </tr>
                }
            </tbody>
        </table>

        @if (!Model.Any())
        {
            <div class="empty-state">
                <p style="font-size: 18px; margin-bottom: 8px;">No live flight data available</p>
                <p>The API may not have returned data for the current time window.</p>
            </div>
        }
    </div>

    <!-- Pagination -->
    <div class="pagination" id="pagination"></div>
</div>

<!-- Flight Details Modal -->
<div class="modal-overlay" id="flightModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeFlightModal()">&times;</button>
        <div class="modal-header">
            <div class="modal-airline" id="modalAirline"></div>
            <div class="modal-flight-number" id="modalFlightNumber"></div>
            <div class="modal-route" id="modalRoute"></div>
        </div>
        <div class="modal-status-banner" id="modalStatusBanner">
            <span id="modalStatus"></span>
        </div>
        <div class="modal-body">
            <!-- Flight Progress Tracker -->
            <div class="flight-progress-section">
                <div class="progress-header">
                    <span class="progress-label" id="progressLabel">Flight Progress</span>
                    <span class="progress-percentage" id="progressPercentage">0%</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-background">
                        <div class="progress-bar-fill" id="progressBarFill"></div>
                    </div>
                    <div class="progress-airports">
                        <div class="progress-airport progress-airport-dep">
                            <div class="progress-airport-code" id="progressDepCode"></div>
                        </div>
                        <div class="progress-plane-icon" id="progressPlane">✈</div>
                        <div class="progress-airport progress-airport-arr">
                            <div class="progress-airport-code" id="progressArrCode"></div>
                        </div>
                    </div>
                </div>
                <div class="progress-time-info">
                    <span id="progressTimeInfo"></span>
                </div>
            </div>
            
            <div class="modal-section">
                <div class="modal-airport-block">
                    <div class="airport-code" id="modalDepCode"></div>
                    <div class="airport-info">
                        <div class="airport-label" id="modalDepCity"></div>
                        <div class="flight-time-group">
                            <div class="time-label" id="depTimeLabel">Scheduled departure</div>
                            <div class="time-display">
                                <span class="time-main" id="modalDepTime"></span>
                                <span class="time-secondary" id="modalDepTimeOriginal"></span>
                            </div>
                        </div>
                        <div class="airport-details">
                            <span class="detail-label">Terminal</span>
                            <span class="detail-value" id="modalDepTerminal"></span>
                            <span class="detail-label">Gate</span>
                            <span class="detail-value" id="modalDepGate"></span>
                        </div>
                    </div>
                </div>
                
                <div class="flight-duration">
                    <div class="duration-icon">✈</div>
                    <div class="duration-text" id="flightDuration"></div>
                </div>
                
                <div class="modal-airport-block">
                    <div class="airport-code" id="modalArrCode"></div>
                    <div class="airport-info">
                        <div class="airport-label" id="modalArrCity"></div>
                        <div class="flight-time-group">
                            <div class="time-label" id="arrTimeLabel">Scheduled arrival</div>
                            <div class="time-display">
                                <span class="time-main" id="modalArrTime"></span>
                                <span class="time-secondary" id="modalArrTimeOriginal"></span>
                            </div>
                        </div>
                        <div class="airport-details">
                            <span class="detail-label">Terminal</span>
                            <span class="detail-value" id="modalArrTerminal"></span>
                            <span class="detail-label">Gate</span>
                            <span class="detail-value" id="modalArrGate"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
(function () {
    const PAGE_SIZE = 25;
    let currentPage = 1;
    let currentDir = 'all';

    const allRows = Array.from(document.querySelectorAll('#flightsTable tbody tr'));
    const buttons = document.querySelectorAll('.filter-btn');
    const pagination = document.getElementById('pagination');

    function getFilteredRows() {
        return allRows.filter(r =>
            currentDir === 'all' || r.getAttribute('data-direction') === currentDir
        );
    }

    function render() {
        const filtered = getFilteredRows();
        const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
        if (currentPage > totalPages) currentPage = totalPages;

        // Hide all rows first
        allRows.forEach(r => r.style.display = 'none');

        // Show only current page rows
        const start = (currentPage - 1) * PAGE_SIZE;
        const end = start + PAGE_SIZE;
        filtered.slice(start, end).forEach(r => r.style.display = '');

        // Build pagination
        let html = '';
        html += '<button class="page-btn" data-page="prev" ' + (currentPage === 1 ? 'disabled' : '') + '>‹ Prev</button>';

        const maxButtons = 7;
        let startPage = Math.max(1, currentPage - 3);
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);
        if (endPage - startPage < maxButtons - 1) startPage = Math.max(1, endPage - maxButtons + 1);

        if (startPage > 1) {
            html += '<button class="page-btn" data-page="1">1</button>';
            if (startPage > 2) html += '<span class="page-ellipsis">…</span>';
        }
        for (let i = startPage; i <= endPage; i++) {
            html += '<button class="page-btn' + (i === currentPage ? ' active' : '') + '" data-page="' + i + '">' + i + '</button>';
        }
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) html += '<span class="page-ellipsis">…</span>';
            html += '<button class="page-btn" data-page="' + totalPages + '">' + totalPages + '</button>';
        }

        html += '<button class="page-btn" data-page="next" ' + (currentPage === totalPages ? 'disabled' : '') + '>Next ›</button>';
        html += '<span class="page-info">Showing ' + (filtered.length ? start + 1 : 0) + '–' + Math.min(end, filtered.length) + ' of ' + filtered.length + '</span>';

        pagination.innerHTML = html;
    }

    // Direction filter
    buttons.forEach(btn => {
        btn.addEventListener('click', function () {
            buttons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentDir = this.getAttribute('data-direction');
            currentPage = 1;
            render();
        });
    });

    // Pagination clicks
    pagination.addEventListener('click', function (e) {
        const btn = e.target.closest('.page-btn');
        if (!btn || btn.disabled) return;
        const val = btn.getAttribute('data-page');
        if (val === 'prev') currentPage--;
        else if (val === 'next') currentPage++;
        else currentPage = parseInt(val);
        render();
        document.querySelector('.flights-section').scrollIntoView({ behavior: 'smooth' });
    });

    render();
})();

// Flight Details Modal Functions
function closeFlightModal() {
    document.getElementById('flightModal').classList.remove('active');
}

function openFlightModal(row) {
    const modal = document.getElementById('flightModal');
    
    // Extract data from row
    const flightNumber = row.getAttribute('data-flight-number');
    const airline = row.getAttribute('data-airline');
    const type = row.getAttribute('data-type');
    const depIata = row.getAttribute('data-dep-iata');
    const arrIata = row.getAttribute('data-arr-iata');
    const depCity = row.getAttribute('data-dep-city');
    const arrCity = row.getAttribute('data-arr-city');
    const depTime = row.getAttribute('data-dep-time');
    const arrTime = row.getAttribute('data-arr-time');
    const depUtc = row.getAttribute('data-dep-utc');
    const arrUtc = row.getAttribute('data-arr-utc');
    const actualDepUtc = row.getAttribute('data-actual-dep-utc');
    const actualArrUtc = row.getAttribute('data-actual-arr-utc');
    const lhrGate = row.getAttribute('data-lhr-gate');
    const lhrTerminal = row.getAttribute('data-lhr-terminal');
    const otherGate = row.getAttribute('data-other-gate');
    const otherTerminal = row.getAttribute('data-other-terminal');
    const status = row.getAttribute('data-status');
    const statusClass = row.getAttribute('data-status-class');
    const rawStatus = row.getAttribute('data-raw-status');
    
    const isDep = type === 'DEP';
    
    // Populate modal
    document.getElementById('modalAirline').textContent = airline;
    document.getElementById('modalFlightNumber').textContent = flightNumber;
    document.getElementById('modalRoute').textContent = `${depIata} to ${arrIata}`;
    
    // Status banner
    const statusBanner = document.getElementById('modalStatusBanner');
    statusBanner.className = 'modal-status-banner ' + statusClass;
    document.getElementById('modalStatus').textContent = (isDep ? 'DEPARTING ' : 'ARRIVING ') + status.toUpperCase();
    
    // Airport codes and cities
    document.getElementById('modalDepCode').textContent = depIata;
    document.getElementById('modalArrCode').textContent = arrIata;
    document.getElementById('modalDepCity').textContent = depCity || depIata;
    document.getElementById('modalArrCity').textContent = arrCity || arrIata;
    
    // Progress bar codes
    document.getElementById('progressDepCode').textContent = depIata;
    document.getElementById('progressArrCode').textContent = arrIata;
    
    // Airport details based on direction
    if (isDep) {
        document.getElementById('modalDepTerminal').textContent = lhrTerminal;
        document.getElementById('modalDepGate').textContent = lhrGate;
        document.getElementById('modalArrTerminal').textContent = otherTerminal;
        document.getElementById('modalArrGate').textContent = otherGate;
    } else {
        document.getElementById('modalDepTerminal').textContent = otherTerminal;
        document.getElementById('modalDepGate').textContent = otherGate;
        document.getElementById('modalArrTerminal').textContent = lhrTerminal;
        document.getElementById('modalArrGate').textContent = lhrGate;
    }
    
    // Times (extract time part from "Mon 10 Feb 14:05" format)
    const depTimeParts = depTime.split(' ');
    const arrTimeParts = arrTime.split(' ');
    const depTimeOnly = depTimeParts.length >= 4 ? depTimeParts.slice(-1)[0] : depTime;
    const arrTimeOnly = arrTimeParts.length >= 4 ? arrTimeParts.slice(-1)[0] : arrTime;
    
    document.getElementById('modalDepTime').textContent = depTimeOnly;
    document.getElementById('modalArrTime').textContent = arrTimeOnly;
    
    // Handle actual times if available
    const depTimeOriginal = document.getElementById('modalDepTimeOriginal');
    const arrTimeOriginal = document.getElementById('modalArrTimeOriginal');
    
    if (actualDepUtc && actualDepUtc !== depUtc) {
        const actualDepDate = new Date(actualDepUtc);
        const actualDepTimeOnly = actualDepDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
        depTimeOriginal.textContent = actualDepTimeOnly;
        depTimeOriginal.style.display = 'inline';
        document.getElementById('depTimeLabel').textContent = 'Actual departure';
    } else {
        depTimeOriginal.style.display = 'none';
        document.getElementById('depTimeLabel').textContent = 'Scheduled departure';
    }
    
    if (actualArrUtc && actualArrUtc !== arrUtc) {
        const actualArrDate = new Date(actualArrUtc);
        const actualArrTimeOnly = actualArrDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
        arrTimeOriginal.textContent = actualArrTimeOnly;
        arrTimeOriginal.style.display = 'inline';
        document.getElementById('arrTimeLabel').textContent = 'Actual arrival';
    } else {
        arrTimeOriginal.style.display = 'none';
        document.getElementById('arrTimeLabel').textContent = 'Scheduled arrival';
    }
    
    // Calculate and display flight progress
    calculateFlightProgress(depUtc, arrUtc, actualDepUtc, actualArrUtc, rawStatus);
    
    modal.classList.add('active');
}

function calculateFlightProgress(depUtc, arrUtc, actualDepUtc, actualArrUtc, rawStatus) {
    if (!depUtc || !arrUtc) {
        document.getElementById('progressLabel').textContent = 'Flight information unavailable';
        document.getElementById('progressPercentage').textContent = '';
        document.getElementById('progressBarFill').style.width = '0%';
        document.getElementById('progressPlane').style.left = '0%';
        document.getElementById('progressTimeInfo').textContent = '';
        return;
    }
    
    const scheduledDep = new Date(depUtc);
    const scheduledArr = new Date(arrUtc);
    const now = new Date();
    
    // Use actual times if available
    const actualDep = actualDepUtc ? new Date(actualDepUtc) : null;
    const actualArr = actualArrUtc ? new Date(actualArrUtc) : null;
    
    // Calculate total flight duration in minutes
    const totalDuration = (scheduledArr - scheduledDep) / 1000 / 60;
    const hours = Math.floor(totalDuration / 60);
    const minutes = Math.round(totalDuration % 60);
    document.getElementById('flightDuration').textContent = `${hours}h ${minutes}m`;
    
    let progress = 0;
    let progressLabel = 'Scheduled';
    let timeInfo = '';
    
    // Determine flight status and calculate progress
    const statusLower = (rawStatus || '').toLowerCase();
    
    if (actualArr || statusLower === 'arrived' || statusLower === 'landed') {
        // Flight has landed
        progress = 100;
        progressLabel = 'Flight Completed';
        if (actualArr) {
            const landingTime = actualArr.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            timeInfo = `Landed at ${landingTime}`;
        } else {
            timeInfo = 'Flight has arrived';
        }
    } else if (actualDep || statusLower === 'departed' || statusLower === 'enroute' || statusLower === 'approaching') {
        // Flight is airborne
        const depTime = actualDep || scheduledDep;
        const elapsed = (now - depTime) / 1000 / 60; // minutes since departure
        progress = Math.min(95, Math.max(5, (elapsed / totalDuration) * 100));
        progressLabel = 'In Flight';
        
        const remaining = totalDuration - elapsed;
        if (remaining > 0) {
            const remHours = Math.floor(remaining / 60);
            const remMinutes = Math.round(remaining % 60);
            if (remHours > 0) {
                timeInfo = `Approximately ${remHours}h ${remMinutes}m remaining`;
            } else {
                timeInfo = `Approximately ${remMinutes}m remaining`;
            }
        } else {
            timeInfo = 'Approaching destination';
        }
    } else if (statusLower === 'boarding' || statusLower === 'gateclosed') {
        // Flight is boarding
        progress = 2;
        progressLabel = 'Boarding';
        const depTime = scheduledDep.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        timeInfo = `Scheduled departure at ${depTime}`;
    } else if (statusLower === 'delayed' || statusLower === 'canceled') {
        // Flight is delayed or cancelled
        progress = 0;
        progressLabel = statusLower === 'canceled' ? 'Flight Cancelled' : 'Delayed';
        timeInfo = statusLower === 'canceled' ? 'This flight has been cancelled' : 'Flight is currently delayed';
    } else if (now < scheduledDep) {
        // Flight hasn't departed yet
        progress = 0;
        progressLabel = 'Scheduled';
        const timeUntilDep = (scheduledDep - now) / 1000 / 60;
        if (timeUntilDep < 60) {
            timeInfo = `Departure in ${Math.round(timeUntilDep)} minutes`;
        } else {
            const hoursUntil = Math.floor(timeUntilDep / 60);
            const minsUntil = Math.round(timeUntilDep % 60);
            timeInfo = `Departure in ${hoursUntil}h ${minsUntil}m`;
        }
    } else {
        // Default case - should have departed but no confirmation
        progress = 0;
        progressLabel = 'Status Unknown';
        timeInfo = 'Flight status information unavailable';
    }
    
    // Update progress bar
    document.getElementById('progressLabel').textContent = progressLabel;
    document.getElementById('progressPercentage').textContent = Math.round(progress) + '%';
    document.getElementById('progressBarFill').style.width = progress + '%';
    document.getElementById('progressPlane').style.left = `calc(${progress}% - 12px)`;
    document.getElementById('progressTimeInfo').textContent = timeInfo;
}

// Add click listeners to flight rows
document.querySelectorAll('.flight-row').forEach(row => {
    row.addEventListener('click', function() {
        openFlightModal(this);
    });
});

// Close modal on overlay click
document.getElementById('flightModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeFlightModal();
    }
});
</script>
}
