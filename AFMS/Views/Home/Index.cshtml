@model List<AFMS.Models.AeroDataBoxFlight>

@{
    ViewData["Title"] = "Dashboard";

    var totalDepartures = Model.Count(f => f.Direction == "Departure");
    var totalArrivals = Model.Count(f => f.Direction == "Arrival");
}

<!-- Page Header -->
<div class="page-header">
    <h1 class="page-title">Dashboard</h1>
    <p class="page-subtitle">London Heathrow Airport (LHR/EGLL) - Live Flight Data</p>
</div>

<!-- Stats Grid - Main -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">✈</div>
        <div class="stat-content">
            <div class="stat-label">Total Flights</div>
            <div class="stat-value">@Model.Count</div>
        </div>
        <div class="stat-badge positive">Live Data</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">🛫</div>
        <div class="stat-content">
            <div class="stat-label">Departures</div>
            <div class="stat-value">@totalDepartures</div>
        </div>
        <div class="stat-badge positive">Live Data</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">🛬</div>
        <div class="stat-content">
            <div class="stat-label">Arrivals</div>
            <div class="stat-value">@totalArrivals</div>
        </div>
        <div class="stat-badge positive">Live Data</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">🏢</div>
        <div class="stat-content">
            <div class="stat-label">Airlines</div>
            <div class="stat-value">@Model.Select(f => f.Airline?.Name).Where(n => n != null).Distinct().Count()</div>
        </div>
        <div class="stat-badge positive">Live Data</div>
    </div>
</div>

<!-- Flights Section -->
<div class="flights-section">
    <div class="flights-header">
        <h2 class="section-title">Live Flights - London Heathrow (LHR)</h2>
        <div class="direction-filters">
            <button class="filter-btn active" data-direction="all">All</button>
            <button class="filter-btn" data-direction="Departure">🛫 Departures</button>
            <button class="filter-btn" data-direction="Arrival">🛬 Arrivals</button>
        </div>
    </div>
    <div class="table-wrapper">
        <table class="flights-table" id="flightsTable">
            <thead>
                <tr>
                    <th>Flight</th>
                    <th>Airline</th>
                    <th>Type</th>
                    <th>Route</th>
                    <th>Departure</th>
                    <th>Arrival</th>
                    <th>Gate</th>
                    <th>Terminal</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var flight in Model)
                {
                    var isDep = flight.Direction == "Departure";
                    // Use movement-level status: departure.status for departures, arrival.status for arrivals
                    var movementStatus = isDep ? flight.Departure?.Status : flight.Arrival?.Status;
                    var rawStatus = (movementStatus ?? flight.Status ?? "Unknown").ToLower();

                    // Simplified status mapping for user-friendly display
                    var statusClass = rawStatus switch
                    {
                        "expected"          => "status-ontime",
                        "enroute"           => "status-departed",
                        "checkin"           => "status-ontime",
                        "boarding"          => "status-boarding",
                        "gateclosed"        => "status-departed",
                        "departed"          => "status-departed",
                        "delayed"           => "status-delayed",
                        "approaching"       => "status-departed",
                        "arrived"           => "status-landed",
                        "canceled"          => "status-cancelled",
                        "canceleduncertain" => "status-cancelled",
                        "diverted"          => "status-cancelled",
                        "unknown"           => "status-ontime",
                        _                   => "status-ontime"
                    };

                    // Simplified status labels
                    var statusLabel = rawStatus switch
                    {
                        "expected"          => "On Time",
                        "enroute"           => "Departed",
                        "checkin"           => "On Time",
                        "boarding"          => "Boarding",
                        "gateclosed"        => "Departed",
                        "departed"          => "Departed",
                        "delayed"           => "Delayed",
                        "approaching"       => "Departed",
                        "arrived"           => "Landed",
                        "canceled"          => "Cancelled",
                        "canceleduncertain" => "Cancelled",
                        "diverted"          => "Cancelled",
                        "unknown"           => "On Time",
                        _                   => "On Time"
                    };

                    // Airport codes — fill in LHR for the home leg
                    var depIata = flight.Departure?.Airport?.Iata
                        ?? (isDep ? "LHR" : (flight.Departure?.Airport?.Name ?? "-"));
                    var arrIata = flight.Arrival?.Airport?.Iata
                        ?? (!isDep ? "LHR" : (flight.Arrival?.Airport?.Name ?? "-"));

                    // Departure date/time with day name
                    var departureTime = "-";
                    if (DateTime.TryParse(flight.Departure?.ScheduledTime?.Local, out var depParsed))
                        departureTime = depParsed.ToString("ddd dd MMM HH:mm");

                    // Arrival date/time with day name
                    var arrivalTime = "-";
                    if (DateTime.TryParse(flight.Arrival?.ScheduledTime?.Local, out var arrParsed))
                        arrivalTime = arrParsed.ToString("ddd dd MMM HH:mm");

                    // Gate / Terminal from the LHR leg
                    var gate = "-";
                    var terminal = "-";
                    var lhrLeg = isDep ? flight.Departure : flight.Arrival;
                    if (lhrLeg != null)
                    {
                        gate = !string.IsNullOrEmpty(lhrLeg.Gate) ? lhrLeg.Gate : "-";
                        terminal = !string.IsNullOrEmpty(lhrLeg.Terminal) ? lhrLeg.Terminal : "-";
                    }

                    var typeLabel = isDep ? "DEP" : "ARR";
                    
                    // Get other airport gate/terminal
                    var otherLeg = isDep ? flight.Arrival : flight.Departure;
                    var otherGate = !string.IsNullOrEmpty(otherLeg?.Gate) ? otherLeg.Gate : "-";
                    var otherTerminal = !string.IsNullOrEmpty(otherLeg?.Terminal) ? otherLeg.Terminal : "-";

                    <tr data-direction="@flight.Direction" 
                        class="flight-row" 
                        data-flight-number="@flight.Number"
                        data-airline="@(flight.Airline?.Name ?? "-")"
                        data-type="@typeLabel"
                        data-dep-iata="@depIata"
                        data-arr-iata="@arrIata"
                        data-dep-time="@departureTime"
                        data-arr-time="@arrivalTime"
                        data-lhr-gate="@gate"
                        data-lhr-terminal="@terminal"
                        data-other-gate="@otherGate"
                        data-other-terminal="@otherTerminal"
                        data-status="@statusLabel"
                        data-status-class="@statusClass">
                        <td class="flight-number">@flight.Number</td>
                        <td>@(flight.Airline?.Name ?? "-")</td>
                        <td>@typeLabel</td>
                        <td>@depIata → @arrIata</td>
                        <td>@departureTime</td>
                        <td>@arrivalTime</td>
                        <td>@gate</td>
                        <td>@terminal</td>
                        <td><span class="status-badge @statusClass">@statusLabel</span></td>
                    </tr>
                }
            </tbody>
        </table>

        @if (!Model.Any())
        {
            <div class="empty-state">
                <p style="font-size: 18px; margin-bottom: 8px;">No live flight data available</p>
                <p>The API may not have returned data for the current time window.</p>
            </div>
        }
    </div>

    <!-- Pagination -->
    <div class="pagination" id="pagination"></div>
</div>

<!-- Flight Details Modal -->
<div class="modal-overlay" id="flightModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeFlightModal()">&times;</button>
        <div class="modal-header">
            <div class="modal-airline" id="modalAirline"></div>
            <div class="modal-flight-number" id="modalFlightNumber"></div>
            <div class="modal-route" id="modalRoute"></div>
        </div>
        <div class="modal-status-banner" id="modalStatusBanner">
            <span id="modalStatus"></span>
        </div>
        <div class="modal-body">
            <div class="modal-section">
                <div class="modal-airport-block">
                    <div class="airport-code" id="modalDepCode">LHR</div>
                    <div class="airport-info">
                        <div class="airport-label">London</div>
                        <div class="flight-time-group">
                            <div class="time-label">Estimated departure</div>
                            <div class="time-display">
                                <span class="time-main" id="modalDepTime">14:05</span>
                                <span class="time-secondary" id="modalDepTimeOriginal">14:00</span>
                            </div>
                        </div>
                        <div class="airport-details">
                            <span class="detail-label">Terminal</span>
                            <span class="detail-value" id="modalDepTerminal">2</span>
                            <span class="detail-label">Gate</span>
                            <span class="detail-value" id="modalDepGate">A22</span>
                        </div>
                    </div>
                </div>
                
                <div class="flight-duration">
                    <div class="duration-icon">✈</div>
                </div>
                
                <div class="modal-airport-block">
                    <div class="airport-code" id="modalArrCode">ORK</div>
                    <div class="airport-info">
                        <div class="airport-label" id="modalArrCity">Cork</div>
                        <div class="flight-time-group">
                            <div class="time-label">Estimated arrival</div>
                            <div class="time-display">
                                <span class="time-main" id="modalArrTime">15:14</span>
                                <span class="time-secondary" id="modalArrTimeOriginal">15:25</span>
                            </div>
                        </div>
                        <div class="airport-details">
                            <span class="detail-label">Terminal</span>
                            <span class="detail-value" id="modalArrTerminal">T1</span>
                            <span class="detail-label">Gate</span>
                            <span class="detail-value" id="modalArrGate">5</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
(function () {
    const PAGE_SIZE = 25;
    let currentPage = 1;
    let currentDir = 'all';

    const allRows = Array.from(document.querySelectorAll('#flightsTable tbody tr'));
    const buttons = document.querySelectorAll('.filter-btn');
    const pagination = document.getElementById('pagination');

    function getFilteredRows() {
        return allRows.filter(r =>
            currentDir === 'all' || r.getAttribute('data-direction') === currentDir
        );
    }

    function render() {
        const filtered = getFilteredRows();
        const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
        if (currentPage > totalPages) currentPage = totalPages;

        // Hide all rows first
        allRows.forEach(r => r.style.display = 'none');

        // Show only current page rows
        const start = (currentPage - 1) * PAGE_SIZE;
        const end = start + PAGE_SIZE;
        filtered.slice(start, end).forEach(r => r.style.display = '');

        // Build pagination
        let html = '';
        html += '<button class="page-btn" data-page="prev" ' + (currentPage === 1 ? 'disabled' : '') + '>‹ Prev</button>';

        const maxButtons = 7;
        let startPage = Math.max(1, currentPage - 3);
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);
        if (endPage - startPage < maxButtons - 1) startPage = Math.max(1, endPage - maxButtons + 1);

        if (startPage > 1) {
            html += '<button class="page-btn" data-page="1">1</button>';
            if (startPage > 2) html += '<span class="page-ellipsis">…</span>';
        }
        for (let i = startPage; i <= endPage; i++) {
            html += '<button class="page-btn' + (i === currentPage ? ' active' : '') + '" data-page="' + i + '">' + i + '</button>';
        }
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) html += '<span class="page-ellipsis">…</span>';
            html += '<button class="page-btn" data-page="' + totalPages + '">' + totalPages + '</button>';
        }

        html += '<button class="page-btn" data-page="next" ' + (currentPage === totalPages ? 'disabled' : '') + '>Next ›</button>';
        html += '<span class="page-info">Showing ' + (filtered.length ? start + 1 : 0) + '–' + Math.min(end, filtered.length) + ' of ' + filtered.length + '</span>';

        pagination.innerHTML = html;
    }

    // Direction filter
    buttons.forEach(btn => {
        btn.addEventListener('click', function () {
            buttons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentDir = this.getAttribute('data-direction');
            currentPage = 1;
            render();
        });
    });

    // Pagination clicks
    pagination.addEventListener('click', function (e) {
        const btn = e.target.closest('.page-btn');
        if (!btn || btn.disabled) return;
        const val = btn.getAttribute('data-page');
        if (val === 'prev') currentPage--;
        else if (val === 'next') currentPage++;
        else currentPage = parseInt(val);
        render();
        document.querySelector('.flights-section').scrollIntoView({ behavior: 'smooth' });
    });

    render();
})();

// Flight Details Modal Functions
function closeFlightModal() {
    document.getElementById('flightModal').classList.remove('active');
}

function openFlightModal(row) {
    const modal = document.getElementById('flightModal');
    
    // Extract data from row
    const flightNumber = row.getAttribute('data-flight-number');
    const airline = row.getAttribute('data-airline');
    const type = row.getAttribute('data-type');
    const depIata = row.getAttribute('data-dep-iata');
    const arrIata = row.getAttribute('data-arr-iata');
    const depTime = row.getAttribute('data-dep-time');
    const arrTime = row.getAttribute('data-arr-time');
    const lhrGate = row.getAttribute('data-lhr-gate');
    const lhrTerminal = row.getAttribute('data-lhr-terminal');
    const otherGate = row.getAttribute('data-other-gate');
    const otherTerminal = row.getAttribute('data-other-terminal');
    const status = row.getAttribute('data-status');
    const statusClass = row.getAttribute('data-status-class');
    
    const isDep = type === 'DEP';
    
    // Populate modal
    document.getElementById('modalAirline').textContent = airline;
    document.getElementById('modalFlightNumber').textContent = flightNumber;
    document.getElementById('modalRoute').textContent = `${depIata} to ${arrIata}`;
    
    // Status banner
    const statusBanner = document.getElementById('modalStatusBanner');
    statusBanner.className = 'modal-status-banner ' + statusClass;
    document.getElementById('modalStatus').textContent = (isDep ? 'DEPARTING ' : 'ARRIVING ') + status.toUpperCase();
    
    // Airport codes and details
    if (isDep) {
        document.getElementById('modalDepCode').textContent = depIata;
        document.getElementById('modalArrCode').textContent = arrIata;
        document.getElementById('modalDepTerminal').textContent = lhrTerminal;
        document.getElementById('modalDepGate').textContent = lhrGate;
        document.getElementById('modalArrTerminal').textContent = otherTerminal;
        document.getElementById('modalArrGate').textContent = otherGate;
    } else {
        document.getElementById('modalDepCode').textContent = depIata;
        document.getElementById('modalArrCode').textContent = arrIata;
        document.getElementById('modalDepTerminal').textContent = otherTerminal;
        document.getElementById('modalDepGate').textContent = otherGate;
        document.getElementById('modalArrTerminal').textContent = lhrTerminal;
        document.getElementById('modalArrGate').textContent = lhrGate;
    }
    
    // Times (extract time part from "Mon 10 Feb 14:05" format)
    const depTimeParts = depTime.split(' ');
    const arrTimeParts = arrTime.split(' ');
    const depTimeOnly = depTimeParts.length >= 4 ? depTimeParts.slice(-1)[0] : depTime;
    const arrTimeOnly = arrTimeParts.length >= 4 ? arrTimeParts.slice(-1)[0] : arrTime;
    
    document.getElementById('modalDepTime').textContent = depTimeOnly;
    document.getElementById('modalArrTime').textContent = arrTimeOnly;
    
    // Hide original times for now (would need actual/revised times from API)
    document.getElementById('modalDepTimeOriginal').style.display = 'none';
    document.getElementById('modalArrTimeOriginal').style.display = 'none';
    
    modal.classList.add('active');
}

// Add click listeners to flight rows
document.querySelectorAll('.flight-row').forEach(row => {
    row.addEventListener('click', function() {
        openFlightModal(this);
    });
});

// Close modal on overlay click
document.getElementById('flightModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeFlightModal();
    }
});
</script>
}
