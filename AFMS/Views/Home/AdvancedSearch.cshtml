@model AFMS.Models.AdvancedSearchViewModel

@{
    ViewData["Title"] = "Advanced Search";
}

@section Styles {
    <link rel="stylesheet" href="~/css/advanced-search.css" />
}

<!-- Page Header -->
<div class="page-header">
    <h1 class="page-title">Advanced Flight Search</h1>
    <p class="page-subtitle">Search and filter live flight records</p>
</div>

<!-- Search Form -->
<div class="search-form-container">
    <form class="search-form" method="get" asp-action="AdvancedSearch" asp-controller="Home">
        <input type="hidden" name="search" value="1" />
        <!-- Row 1: Flight, Airline, Destination -->
        <div class="form-row">
            <div class="form-group">
                <label for="flight" class="form-label">Flight</label>
                <input type="text" id="flight" name="flight" class="form-input" placeholder="e.g., VY 5227" value="@Model.Flight" />
            </div>
            <div class="form-group">
                <label for="airline" class="form-label">Airline</label>
                <input type="text" id="airline" name="airline" class="form-input" placeholder="e.g., British" value="@Model.Airline" />
            </div>
            <div class="form-group">
                <label for="destination" class="form-label">Flight Destination</label>
                <input type="text" id="destination" name="destination" class="form-input" list="airportOptions" placeholder="e.g., MAD or Madrid" value="@Model.Destination" />
            </div>
        </div>

        <!-- Row 2: Departure Date, Arrival Date, Terminal -->
        <div class="form-row">
            <div class="form-group">
                <label for="departureDate" class="form-label">Departure Date</label>
                <input type="date" id="departureDate" name="departureDate" class="form-input" value="@Model.DepartureDate?.ToString("yyyy-MM-dd")" />
            </div>
            <div class="form-group">
                <label for="arrivalDate" class="form-label">Arrival Date</label>
                <input type="date" id="arrivalDate" name="arrivalDate" class="form-input" value="@Model.ArrivalDate?.ToString("yyyy-MM-dd")" />
            </div>
            <div class="form-group">
                <label for="terminal" class="form-label">Terminal</label>
                <input type="text" id="terminal" name="terminal" class="form-input" placeholder="e.g., 5" value="@Model.Terminal" />
            </div>
        </div>

        <!-- Row 3: Status Buttons -->
        <div class="form-row">
            <div class="form-group" style="grid-column: 1 / -1;">
                <label class="form-label">Flight Status</label>
                <input type="hidden" id="statusInput" name="status" value="@Model.Status" />
                <div class="status-buttons">
                    <button type="button" class="status-btn" data-status="Expected">Scheduled</button>
                    <button type="button" class="status-btn" data-status="Boarding">Boarding</button>
                    <button type="button" class="status-btn" data-status="Departed">Departed</button>
                    <button type="button" class="status-btn" data-status="Arrived">Arrived</button>
                    <button type="button" class="status-btn" data-status="Delayed">Delayed</button>
                    <button type="button" class="status-btn" data-status="Canceled">Cancelled</button>
                </div>
            </div>
        </div>

        <datalist id="airportOptions">
            <option value="EGLL">London Heathrow (EGLL)</option>
            <option value="KJFK">John F. Kennedy (KJFK)</option>
            <option value="KLAX">Los Angeles (KLAX)</option>
            <option value="OMDB">Dubai (OMDB)</option>
            <option value="EDDF">Frankfurt (EDDF)</option>
            <option value="RJTT">Tokyo Haneda (RJTT)</option>
        </datalist>

        <!-- Action Buttons -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                <span class="btn-icon">üîç</span>
                Search Flights
            </button>
            <button type="button" class="btn btn-secondary" id="clearFiltersBtn">
                Clear Filters
            </button>
        </div>
    </form>

    <p class="api-hint">Tip: every filter is optional. You can search with just one field (for example only Flight or only Airline).</p>
</div>

@if (Model.HasSearched)
{
    <div class="flights-section advanced-results">
        <div class="flights-header">
            <h2 class="section-title">Search Results (@Model.Results.Count)</h2>
            <div class="result-meta">API airport: @Model.UsedAirportCode</div>
        </div>

        @if (!string.IsNullOrWhiteSpace(Model.Notice))
        {
            <div class="search-notice">@Model.Notice</div>
        }

        @if (!Model.Results.Any())
        {
            <div class="empty-state">
                <p style="font-size: 18px; margin-bottom: 8px;">No flights matched your filters</p>
                <p>Try a different airport code, broader dates, or fewer filters.</p>
            </div>
        }
        else
        {
            <div class="table-wrapper">
                <table class="flights-table">
                    <thead>
                    <tr>
                        <th>Flight</th>
                        <th>Airline</th>
                        <th>Type</th>
                        <th>Route</th>
                        <th>Departure</th>
                        <th>Arrival</th>
                        <th>Terminal</th>
                        <th>Status</th>
                    </tr>
                    </thead>
                    <tbody>
                    @foreach (var flight in Model.Results)
                    {
                        var isDep = flight.Direction == "Departure";
                        var movementStatus = isDep ? flight.Departure?.Status : flight.Arrival?.Status;
                        var rawStatus = (movementStatus ?? flight.Status ?? "Unknown").ToLower();

                        var statusClass = rawStatus switch
                        {
                            "expected"          => "status-ontime",
                            "enroute"           => "status-departed",
                            "checkin"           => "status-ontime",
                            "boarding"          => "status-boarding",
                            "gateclosed"        => "status-departed",
                            "departed"          => "status-departed",
                            "delayed"           => "status-delayed",
                            "approaching"       => "status-departed",
                            "arrived"           => "status-landed",
                            "canceled"          => "status-cancelled",
                            "canceleduncertain" => "status-cancelled",
                            "diverted"          => "status-cancelled",
                            "unknown"           => "status-ontime",
                            _                   => "status-ontime"
                        };

                        var statusLabel = rawStatus switch
                        {
                            "expected"          => "On Time",
                            "enroute"           => "Departed",
                            "checkin"           => "On Time",
                            "boarding"          => "Boarding",
                            "gateclosed"        => "Departed",
                            "departed"          => "Departed",
                            "delayed"           => "Delayed",
                            "approaching"       => "Departed",
                            "arrived"           => "Landed",
                            "canceled"          => "Cancelled",
                            "canceleduncertain" => "Cancelled",
                            "diverted"          => "Cancelled",
                            "unknown"           => "On Time",
                            _                   => "On Time"
                        };

                        // Helper function to convert ICAO to IATA codes for display
                        string ConvertToIata(string code)
                        {
                            if (string.IsNullOrWhiteSpace(code)) return "";
                            return code.ToUpper() switch
                            {
                                "EGLL" => "LHR",
                                "KJFK" => "JFK",
                                "KLAX" => "LAX",
                                "OMDB" => "DXB",
                                "EDDF" => "FRA",
                                "RJTT" => "HND",
                                _ => code
                            };
                        }

                        var depIata = flight.Departure?.Airport?.Iata ?? ConvertToIata(flight.Departure?.Airport?.Icao ?? "");
                        var arrIata = flight.Arrival?.Airport?.Iata ?? ConvertToIata(flight.Arrival?.Airport?.Icao ?? "");

                        if (string.IsNullOrWhiteSpace(depIata) && isDep)
                            depIata = ConvertToIata(Model.UsedAirportCode ?? "-");
                        else if (string.IsNullOrWhiteSpace(depIata))
                            depIata = "-";

                        if (string.IsNullOrWhiteSpace(arrIata) && !isDep)
                            arrIata = ConvertToIata(Model.UsedAirportCode ?? "-");
                        else if (string.IsNullOrWhiteSpace(arrIata))
                            arrIata = "-";

                        var depCity = flight.Departure?.Airport?.MunicipalityName ?? flight.Departure?.Airport?.ShortName ?? depIata;
                        var arrCity = flight.Arrival?.Airport?.MunicipalityName ?? flight.Arrival?.Airport?.ShortName ?? arrIata;

                        var departureTime = "-";
                        if (DateTime.TryParse(flight.Departure?.ScheduledTime?.Local, out var depParsed))
                            departureTime = depParsed.ToString("ddd dd MMM HH:mm");

                        var arrivalTime = "-";
                        if (DateTime.TryParse(flight.Arrival?.ScheduledTime?.Local, out var arrParsed))
                            arrivalTime = arrParsed.ToString("ddd dd MMM HH:mm");

                        var lhrLeg = isDep ? flight.Departure : flight.Arrival;
                        var gate = !string.IsNullOrWhiteSpace(lhrLeg?.Gate) ? lhrLeg.Gate : "-";
                        var terminal = !string.IsNullOrWhiteSpace(lhrLeg?.Terminal) ? lhrLeg.Terminal : "-";

                        var depUtc = flight.Departure?.ScheduledTime?.Utc ?? "";
                        var arrUtc = flight.Arrival?.ScheduledTime?.Utc ?? "";
                        var runwayDepUtc = flight.Departure?.RunwayTime?.Utc ?? "";
                        var runwayArrUtc = flight.Arrival?.RunwayTime?.Utc ?? "";
                        var revisedDepUtc = flight.Departure?.RevisedTime?.Utc ?? "";
                        var revisedArrUtc = flight.Arrival?.RevisedTime?.Utc ?? "";
                        var predictedDepUtc = flight.Departure?.PredictedTime?.Utc ?? "";
                        var predictedArrUtc = flight.Arrival?.PredictedTime?.Utc ?? "";

                        var detailedStatus = statusLabel;
                        var hasActuallyDeparted = !string.IsNullOrEmpty(runwayDepUtc) || rawStatus == "enroute" || rawStatus == "approaching" || rawStatus == "departed" || rawStatus == "gateclosed";
                        var hasActuallyArrived = !string.IsNullOrEmpty(runwayArrUtc) || rawStatus == "arrived";

                        if (hasActuallyArrived)
                        {
                            if (DateTime.TryParse(runwayArrUtc, out var actArrTime))
                                detailedStatus = $"Landed {actArrTime.ToLocalTime().ToString("HH:mm")}";
                            else
                                detailedStatus = "Landed";
                            statusLabel = "Landed";
                            statusClass = "status-landed";
                        }
                        else if (hasActuallyDeparted && isDep)
                        {
                            if (DateTime.TryParse(runwayDepUtc, out var actDepTime))
                                detailedStatus = $"Departed {actDepTime.ToLocalTime().ToString("HH:mm")}";
                            else
                                detailedStatus = "Departed";
                            statusLabel = "Departed";
                            statusClass = "status-departed";
                        }
                        else if (hasActuallyDeparted && !isDep)
                        {
                            detailedStatus = rawStatus == "approaching" ? "Approaching" : "In Flight";
                            statusLabel = detailedStatus;
                            statusClass = "status-departed";
                        }
                        else if (rawStatus == "delayed")
                        {
                            detailedStatus = "Delayed";
                        }
                        else if (rawStatus == "boarding")
                        {
                            detailedStatus = "Boarding";
                        }
                        else if (rawStatus == "canceled")
                        {
                            detailedStatus = "Canceled";
                        }

                        var typeLabel = isDep ? "DEP" : "ARR";
                        var typeClass = isDep ? "type-dep" : "type-arr";
                        var displayTime = departureTime.Split(' ').Last();

                        <tr class="flight-row"
                            data-direction="@flight.Direction"
                            data-flight-number="@flight.Number"
                            data-airline="@(flight.Airline?.Name ?? "-")"
                            data-dep-iata="@depIata"
                            data-arr-iata="@arrIata"
                            data-dep-city="@depCity"
                            data-arr-city="@arrCity"
                            data-dep-time="@departureTime"
                            data-arr-time="@arrivalTime"
                            data-dep-utc="@depUtc"
                            data-arr-utc="@arrUtc"
                            data-runway-dep-utc="@runwayDepUtc"
                            data-runway-arr-utc="@runwayArrUtc"
                            data-revised-dep-utc="@revisedDepUtc"
                            data-revised-arr-utc="@revisedArrUtc"
                            data-predicted-dep-utc="@predictedDepUtc"
                            data-predicted-arr-utc="@predictedArrUtc"
                            data-raw-status="@rawStatus"
                            data-gate="@gate"
                            data-terminal="@terminal"
                            data-status-class="@statusClass"
                            data-status-label="@detailedStatus">
                            <td class="flight-number">@flight.Number</td>
                            <td>@(flight.Airline?.Name ?? "-")</td>
                            <td><span class="type-badge @typeClass">@typeLabel</span></td>
                            <td>@depIata ‚Üí @arrIata</td>
                            <td class="mono">@displayTime</td>
                            <td class="mono">@arrivalTime.Split(' ').Last()</td>
                            <td>@terminal</td>
                            <td><span class="status-badge @statusClass">@detailedStatus</span></td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        }
    </div>
}

<!-- Flight Details Modal (identical to Dashboard) -->
<div class="modal-overlay" id="flightModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeFlightModal()">&times;</button>
        <div class="modal-header">
            <div class="modal-airline" id="modalAirline"></div>
            <div class="modal-flight-number" id="modalFlightNumber"></div>
            <div class="modal-route" id="modalRoute"></div>
        </div>
        <div class="modal-status-banner" id="modalStatusBanner">
            <span id="modalStatus"></span>
        </div>
        <div class="modal-body">
            <!-- Flight Progress Tracker -->
            <div class="flight-progress-section">
                <div class="progress-header">
                    <span class="progress-label" id="progressLabel">Flight Progress</span>
                </div>
                <div class="progress-route">
                    <div class="progress-airport-info" id="progressDepCode"></div>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar">
                            <div class="progress-bar-fill" id="progressBarFill"></div>
                            <div class="progress-indicator" id="progressPlane"></div>
                        </div>
                    </div>
                    <div class="progress-airport-info" id="progressArrCode"></div>
                </div>
                <div class="progress-time-info" id="progressTimeInfo"></div>
            </div>

            <div class="modal-section">
                <div class="modal-airport-block">
                    <div class="airport-code" id="modalDepCode"></div>
                    <div class="airport-info">
                        <div class="airport-label" id="modalDepCity"></div>
                        <div class="flight-time-group">
                            <div class="time-label" id="depTimeLabel">Scheduled departure</div>
                            <div class="time-display">
                                <span class="time-main" id="modalDepTime"></span>
                                <span class="time-secondary" id="modalDepTimeOriginal"></span>
                            </div>
                        </div>
                        <div class="airport-details">
                            <span class="detail-label">Terminal</span>
                            <span class="detail-value" id="modalDepTerminal"></span>
                            <span class="detail-label">Gate</span>
                            <span class="detail-value" id="modalDepGate"></span>
                        </div>
                    </div>
                </div>

                <div class="flight-duration">
                    <div class="duration-text" id="flightDuration"></div>
                </div>

                <div class="modal-airport-block">
                    <div class="airport-code" id="modalArrCode"></div>
                    <div class="airport-info">
                        <div class="airport-label" id="modalArrCity"></div>
                        <div class="flight-time-group">
                            <div class="time-label" id="arrTimeLabel">Scheduled arrival</div>
                            <div class="time-display">
                                <span class="time-main" id="modalArrTime"></span>
                                <span class="time-secondary" id="modalArrTimeOriginal"></span>
                            </div>
                        </div>
                        <div class="airport-details">
                            <span class="detail-label">Terminal</span>
                            <span class="detail-value" id="modalArrTerminal"></span>
                            <span class="detail-label">Gate</span>
                            <span class="detail-value" id="modalArrGate"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const clearBtn = document.getElementById('clearFiltersBtn');
        const form = document.querySelector('.search-form');
        const statusInput = document.getElementById('statusInput');
        const statusButtons = document.querySelectorAll('.status-btn');

        // Handle status button clicks
        statusButtons.forEach(btn => {
            const btnStatus = btn.dataset.status;

            // Set initial active state
            if (statusInput && statusInput.value === btnStatus) {
                btn.classList.add('active');
            }

            btn.addEventListener('click', (e) => {
                e.preventDefault();

                if (btn.classList.contains('active')) {
                    btn.classList.remove('active');
                    statusInput.value = '';
                } else {
                    statusButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    statusInput.value = btnStatus;
                }
            });
        });

        if (clearBtn && form) {
            clearBtn.addEventListener('click', () => {
                statusButtons.forEach(b => b.classList.remove('active'));
                form.reset();
                window.location.href = '@Url.Action("AdvancedSearch", "Home")';
            });
        }

        // Flight Details Modal Functions
        function closeFlightModal() {
            document.getElementById('flightModal').classList.remove('active');
        }

        function attachFlightRowHandlers() {
            document.querySelectorAll('.flight-row').forEach(row => {
                row.onclick = function() {
                    openFlightModal(this);
                };
                row.style.cursor = 'pointer';
            });
        }

        function openFlightModal(row) {
            const modal = document.getElementById('flightModal');

            const flightNumber = row.getAttribute('data-flight-number');
            const airline = row.getAttribute('data-airline');
            const direction = row.getAttribute('data-direction');
            const depIata = row.getAttribute('data-dep-iata');
            const arrIata = row.getAttribute('data-arr-iata');
            const depCity = row.getAttribute('data-dep-city');
            const arrCity = row.getAttribute('data-arr-city');
            const depTime = row.getAttribute('data-dep-time');
            const arrTime = row.getAttribute('data-arr-time');
            const depUtc = row.getAttribute('data-dep-utc');
            const arrUtc = row.getAttribute('data-arr-utc');
            const runwayDepUtc = row.getAttribute('data-runway-dep-utc');
            const runwayArrUtc = row.getAttribute('data-runway-arr-utc');
            const revisedDepUtc = row.getAttribute('data-revised-dep-utc');
            const revisedArrUtc = row.getAttribute('data-revised-arr-utc');
            const predictedDepUtc = row.getAttribute('data-predicted-dep-utc');
            const predictedArrUtc = row.getAttribute('data-predicted-arr-utc');
            const rawStatus = row.getAttribute('data-raw-status');
            const gate = row.getAttribute('data-gate');
            const terminal = row.getAttribute('data-terminal');
            const statusClass = row.getAttribute('data-status-class');
            const statusLabel = row.getAttribute('data-status-label');

            const isDep = direction === 'Departure';

            document.getElementById('modalAirline').textContent = airline;
            document.getElementById('modalFlightNumber').textContent = flightNumber;
            document.getElementById('modalRoute').textContent = `${depIata} to ${arrIata}`;

            const statusBanner = document.getElementById('modalStatusBanner');
            statusBanner.className = 'modal-status-banner ' + statusClass;
            document.getElementById('modalStatus').textContent = statusLabel;

            document.getElementById('modalDepCode').textContent = depIata;
            document.getElementById('modalArrCode').textContent = arrIata;
            document.getElementById('modalDepCity').textContent = depCity;
            document.getElementById('modalArrCity').textContent = arrCity;

            const depLabel = depCity && depCity !== depIata ? `${depIata} ${depCity}` : depIata;
            const arrLabel = arrCity && arrCity !== arrIata ? `${arrIata} ${arrCity}` : arrIata;
            document.getElementById('progressDepCode').textContent = depLabel;
            document.getElementById('progressArrCode').textContent = arrLabel;

            document.getElementById('modalDepTerminal').textContent = isDep ? terminal : '-';
            document.getElementById('modalDepGate').textContent = isDep ? gate : '-';
            document.getElementById('modalArrTerminal').textContent = !isDep ? terminal : '-';
            document.getElementById('modalArrGate').textContent = !isDep ? gate : '-';

            document.getElementById('modalDepTime').textContent = depTime.split(' ').pop();
            document.getElementById('modalArrTime').textContent = arrTime.split(' ').pop();

            const depTimeOriginal = document.getElementById('modalDepTimeOriginal');
            const arrTimeOriginal = document.getElementById('modalArrTimeOriginal');

            if (runwayDepUtc) {
                depTimeOriginal.textContent = new Date(runwayDepUtc).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                depTimeOriginal.style.display = 'inline';
                document.getElementById('depTimeLabel').textContent = 'Actual departure';
            } else {
                depTimeOriginal.style.display = 'none';
                document.getElementById('depTimeLabel').textContent = 'Scheduled departure';
            }

            if (runwayArrUtc) {
                arrTimeOriginal.textContent = new Date(runwayArrUtc).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                arrTimeOriginal.style.display = 'inline';
                document.getElementById('arrTimeLabel').textContent = 'Actual arrival';
            } else {
                arrTimeOriginal.style.display = 'none';
                document.getElementById('arrTimeLabel').textContent = 'Scheduled arrival';
            }

            calculateFlightProgress(depUtc, arrUtc, runwayDepUtc, runwayArrUtc, revisedDepUtc, revisedArrUtc, predictedDepUtc, predictedArrUtc, rawStatus);

            modal.classList.add('active');
        }

        function calculateFlightProgress(depUtc, arrUtc, runwayDepUtc, runwayArrUtc, revisedDepUtc, revisedArrUtc, predictedDepUtc, predictedArrUtc, rawStatus) {
            if (!depUtc || !arrUtc) {
                document.getElementById('progressLabel').textContent = 'No data';
                document.getElementById('progressBarFill').style.width = '0%';
                document.getElementById('progressPlane').style.left = '0%';
                document.getElementById('progressTimeInfo').textContent = '';
                return;
            }

            const depTime = new Date(depUtc);
            const arrTime = new Date(arrUtc);
            const now = new Date();

            // Flight duration
            const totalMins = (arrTime - depTime) / 60000;
            const hrs = Math.floor(totalMins / 60);
            const mins = Math.round(totalMins % 60);
            document.getElementById('flightDuration').textContent = `${hrs}h ${mins}m`;

            let progress = 0;
            let label = 'Scheduled';
            let info = '';

            const hasActuallyArrived = (runwayArrUtc && runwayArrUtc !== '') || rawStatus === 'arrived';
            const hasActuallyDeparted = (runwayDepUtc && runwayDepUtc !== '') ||
                                        rawStatus === 'enroute' ||
                                        rawStatus === 'approaching' ||
                                        rawStatus === 'departed' ||
                                        rawStatus === 'gateclosed';

            if (hasActuallyArrived) {
                progress = 100;
                label = 'Arrived';
                info = 'Flight completed';
            } else if (hasActuallyDeparted) {
                let actualDep;
                if (runwayDepUtc && runwayDepUtc !== '') {
                    actualDep = new Date(runwayDepUtc);
                } else if (revisedDepUtc && revisedDepUtc !== '') {
                    actualDep = new Date(revisedDepUtc);
                } else if (predictedDepUtc && predictedDepUtc !== '') {
                    actualDep = new Date(predictedDepUtc);
                } else {
                    actualDep = depTime;
                }

                let estimatedArr;
                if (revisedArrUtc && revisedArrUtc !== '') {
                    estimatedArr = new Date(revisedArrUtc);
                } else if (predictedArrUtc && predictedArrUtc !== '') {
                    estimatedArr = new Date(predictedArrUtc);
                } else {
                    estimatedArr = arrTime;
                }

                const elapsed = (now - actualDep) / 60000;
                const flightDuration = (estimatedArr - actualDep) / 60000;

                if (elapsed > 0 && flightDuration > 0) {
                    progress = Math.min(95, Math.max(5, (elapsed / flightDuration) * 100));
                    label = rawStatus === 'approaching' ? 'Approaching' : 'In Flight';
                    const remaining = Math.max(0, flightDuration - elapsed);
                    const remHrs = Math.floor(remaining / 60);
                    const remMins = Math.round(remaining % 60);
                    info = remHrs > 0 ? `${remHrs}h ${remMins}m remaining` : `${remMins} min remaining`;
                } else {
                    progress = 5;
                    label = 'Departed';
                    info = 'Flight in progress';
                }
            } else {
                progress = 0;
                label = rawStatus === 'boarding' ? 'Boarding' : rawStatus === 'delayed' ? 'Delayed' : 'Scheduled';

                let effectiveDep = depTime;
                if (revisedDepUtc && revisedDepUtc !== '') {
                    effectiveDep = new Date(revisedDepUtc);
                } else if (predictedDepUtc && predictedDepUtc !== '') {
                    effectiveDep = new Date(predictedDepUtc);
                }

                const timeUntil = (effectiveDep - now) / 60000;
                if (timeUntil > 0 && timeUntil < 120) {
                    info = timeUntil < 60 ? `Departs in ${Math.round(timeUntil)} min` : `Departs in ${Math.floor(timeUntil / 60)}h ${Math.round(timeUntil % 60)}m`;
                } else if (timeUntil < 0) {
                    info = 'Flight delayed or status unknown';
                } else {
                    info = `Departs ${effectiveDep.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}`;
                }
            }

            document.getElementById('progressLabel').textContent = label;
            document.getElementById('progressBarFill').style.width = progress + '%';
            document.getElementById('progressPlane').style.left = progress + '%';
            document.getElementById('progressTimeInfo').textContent = info;
        }

        // Close modal on overlay click
        document.getElementById('flightModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeFlightModal();
            }
        });

        // Attach click handlers to flight rows
        attachFlightRowHandlers();
    </script>
}
